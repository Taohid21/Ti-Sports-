<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Group Video Call - BGMSS</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg-dark: #000000;
            --control-bg: #1e1e1e;
            --primary: #2563eb;
            --danger: #ef4444;
            --avatar-bg: #374151;
            --safe-bottom: 90px; /* Space for controls */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            background-color: var(--bg-dark);
            color: white;
            font-family: 'Inter', sans-serif;
            height: 100dvh; /* Dynamic height for mobile browsers */
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- LOBBY SCREEN (Clean Modern) --- */
        #lobby-screen {
            position: fixed; inset: 0;
            background: #121212;
            display: flex; flex-direction: column;
            justify-content: center; alignItems: center;
            z-index: 2000; padding: 20px;
        }

        .lobby-content {
            text-align: center; width: 100%; max-width: 350px;
        }

        .lobby-avatar {
            width: 100px; height: 100px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-radius: 50%; margin: 0 auto 30px;
            display: flex; justify-content: center; align-items: center;
            font-size: 40px; box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
        }

        .action-btn {
            background: white; color: black;
            border: none; padding: 18px; width: 100%;
            border-radius: 50px; font-size: 16px; font-weight: 700;
            margin-top: 20px; cursor: pointer; transition: 0.2s;
        }
        .action-btn:active { transform: scale(0.95); opacity: 0.9; }
        .action-btn:disabled { opacity: 0.5; }

        /* --- MAIN VIDEO GRID LAYOUT --- */
        #app-interface {
            display: none;
            flex: 1;
            height: 100%;
            position: relative;
        }

        /* Container for all videos - Ensures NO overlap with controls */
        #video-grid {
            height: calc(100dvh - var(--safe-bottom));
            width: 100%;
            display: grid;
            gap: 2px;
            background: #000;
            transition: all 0.3s ease;
        }

        /* DYNAMIC LAYOUT LOGIC */
        /* 1 User: Full Screen */
        .layout-1 { grid-template-columns: 1fr; }

        /* 2 Users: Mobile (Stack), Desktop (Side-by-Side) */
        .layout-2 { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
        @media (min-width: 768px) { .layout-2 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr; } }

        /* 3+ Users: Auto Grid */
        .layout-3 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        .layout-many { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }

        /* VIDEO WRAPPER STYLES */
        .video-wrapper {
            position: relative;
            width: 100%; height: 100%;
            overflow: hidden;
            background: #1a1a1a;
        }

        video {
            width: 100%; height: 100%;
            object-fit: cover;
            /* object-fit: contain;  <-- Use this if you don't want any cropping, but 'cover' looks more modern/full */
        }

        /* --- SMART AVATAR (VIDEO OFF STATE) --- */
        .avatar-placeholder {
            position: absolute; inset: 0;
            background: #1f2937;
            display: none; /* Hidden by default */
            flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 2;
        }

        .video-wrapper.video-off .avatar-placeholder { display: flex; }
        .video-wrapper.video-off video { opacity: 0; }

        .avatar-circle {
            width: 80px; height: 80px;
            background: #374151; color: #9ca3af;
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 30px; font-weight: 600;
            margin-bottom: 10px;
            border: 2px solid rgba(255,255,255,0.1);
        }
        
        /* Audio Indicator Pulse */
        .talking .avatar-circle {
            animation: pulse-border 1.5s infinite;
            border-color: var(--primary); color: var(--primary);
        }
        
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(37, 99, 235, 0); }
            100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
        }

        /* --- LOCAL VIDEO (PIP STYLE) --- */
        /* This floats on top of the grid but never covers controls */
        #local-video-container {
            position: absolute;
            bottom: calc(var(--safe-bottom) + 15px);
            right: 15px;
            width: 110px; height: 160px; /* Portrait ratio for mobile */
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.2);
            z-index: 100;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }
        
        /* If only 1 person (me), hide PiP and show in main grid */
        #local-video-container.is-main {
            display: none; 
        }

        /* --- CONTROLS BAR (FIXED BOTTOM) --- */
        .controls-bar {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: var(--safe-bottom);
            background: #000;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 20px;
            z-index: 500;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .ctrl-btn {
            width: 50px; height: 50px;
            border-radius: 50%;
            border: none;
            background: #1f1f1f;
            color: white;
            font-size: 20px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .ctrl-btn:active { transform: scale(0.9); }
        .ctrl-btn.btn-off { background: white; color: black; } /* High contrast for off state */
        .ctrl-btn.leave { background: #ef4444; color: white; }

        /* Hide header info during call on mobile */
        #header-info {
            position: absolute; top: 15px; left: 15px;
            background: rgba(0,0,0,0.5);
            padding: 5px 12px; border-radius: 20px;
            font-size: 12px; z-index: 10;
            pointer-events: none;
        }

    </style>
</head>
<body>

    <!-- LOBBY -->
    <div id="lobby-screen">
        <div class="lobby-content">
            <div class="lobby-avatar"><i class="fas fa-video"></i></div>
            <h2 style="margin: 0 0 10px 0;">Ready to Join?</h2>
            <p id="room-status" style="color: #9ca3af; margin-bottom: 30px; font-size: 14px;">Checking room...</p>
            <button id="join-btn" class="action-btn" onclick="startCall()" disabled>Join Now</button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-interface">
        <div id="header-info">
            <span style="color: #4ade80;">‚óè</span> Live
        </div>

        <!-- The Main Grid for Remote Users -->
        <div id="video-grid" class="layout-1">
            <!-- Videos injected via JS -->
        </div>

        <!-- My Local Video (PiP) -->
        <div id="local-video-container">
            <video id="localVideo" autoplay playsinline muted style="transform: scaleX(-1);"></video>
            <!-- Avatar for myself -->
            <div class="avatar-placeholder">
                <div class="avatar-circle">Me</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-bar">
            <button class="ctrl-btn" id="micBtn" onclick="toggleMic()">
                <i class="fas fa-microphone"></i>
            </button>
            <button class="ctrl-btn leave" onclick="leaveCall()">
                <i class="fas fa-phone-slash"></i>
            </button>
            <button class="ctrl-btn" id="camBtn" onclick="toggleCam()">
                <i class="fas fa-video"></i>
            </button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyD_HBGuQSh_GzqrHqHbgdaoBikLZsK3Qqs",
            authDomain: "new-all-f99f7.firebaseapp.com",
            databaseURL: "https://new-all-f99f7-default-rtdb.firebaseio.com",
            projectId: "new-all-f99f7",
            storageBucket: "new-all-f99f7.firebasestorage.app",
            messagingSenderId: "1069748173900",
            appId: "1:1069748173900:web:158d6336c0f4628133c8e9"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const ROOM_ID = "mobile_optimized_room";
        const localId = "user_" + Math.random().toString(36).substr(2, 5);

        // State
        let localStream;
        let peerConnections = {};
        let remoteUsers = []; // Track user IDs for grid logic

        // DOM
        const videoGrid = document.getElementById('video-grid');
        const localVidContainer = document.getElementById('local-video-container');

        // --- 1. LOBBY LOGIC ---
        db.collection('rooms').doc(ROOM_ID).collection('participants').onSnapshot(snap => {
            const count = snap.size;
            document.getElementById('room-status').innerText = count === 0 ? "Room is empty" : `${count} people in call`;
            document.getElementById('join-btn').disabled = false;
        });

        // --- 2. START CALL ---
        async function startCall() {
            document.getElementById('join-btn').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: "user" }, // Mobile optimized
                    audio: true 
                });
                
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('lobby-screen').style.display = 'none';
                document.getElementById('app-interface').style.display = 'block';

                // Initial Layout Update
                updateGridLayout();

                // Firestore Join
                await joinRoom();

            } catch (e) {
                alert("Camera/Mic permission needed!");
                location.reload();
            }
        }

        // --- 3. LAYOUT ENGINE (The Smart Part) ---
        function updateGridLayout() {
            const count = remoteUsers.length; 
            
            // Logic: 
            // If 0 remote users -> I am alone -> Show me in full screen (Grid) and hide PiP.
            // If > 0 remote users -> Show them in Grid, Show me in PiP.

            videoGrid.className = ''; // Reset classes
            
            if (count === 0) {
                // Alone mode: Move my stream to grid or simulate it?
                // For simplicity in this specific code structure:
                // We keep PiP visible but maybe make it bigger? 
                // Or better: In this app, the Main Grid is for REMOTE users. 
                // If I am alone, the grid is empty.
                
                // Let's make "Selfie Mode" if alone
                videoGrid.style.display = 'none';
                localVidContainer.style.width = '100%';
                localVidContainer.style.height = 'calc(100% - 90px)';
                localVidContainer.style.inset = '0';
                localVidContainer.style.borderRadius = '0';
                localVidContainer.style.zIndex = '1'; // Below controls
                document.getElementById('localVideo').style.transform = 'scaleX(-1)'; // Mirror
            } else {
                // Connected mode
                videoGrid.style.display = 'grid';
                
                // Restore PiP styles
                localVidContainer.style = ""; // Reset inline styles to revert to CSS class
                localVidContainer.style.bottom = "105px";
                localVidContainer.style.right = "15px";
                
                // Grid Classes based on remote count
                if (count === 1) videoGrid.classList.add('layout-1');
                else if (count === 2) videoGrid.classList.add('layout-2');
                else videoGrid.classList.add('layout-3');
            }
        }

        // --- 4. VIDEO/AUDIO TOGGLES & AVATAR LOGIC ---
        function toggleCam() {
            const videoTrack = localStream.getVideoTracks()[0];
            videoTrack.enabled = !videoTrack.enabled;
            
            const btn = document.getElementById('camBtn');
            const wrapper = document.getElementById('local-video-container'); // Apply class here for local

            if (videoTrack.enabled) {
                btn.classList.remove('btn-off');
                btn.innerHTML = '<i class="fas fa-video"></i>';
                wrapper.classList.remove('video-off');
                
                // Inform others
                updateMyStatus({ video: true });
            } else {
                btn.classList.add('btn-off');
                btn.innerHTML = '<i class="fas fa-video-slash"></i>';
                wrapper.classList.add('video-off');
                
                // Inform others
                updateMyStatus({ video: false });
            }
        }

        function toggleMic() {
            const audioTrack = localStream.getAudioTracks()[0];
            audioTrack.enabled = !audioTrack.enabled;
            
            const btn = document.getElementById('micBtn');
            if (audioTrack.enabled) {
                btn.classList.remove('btn-off');
                btn.innerHTML = '<i class="fas fa-microphone"></i>';
            } else {
                btn.classList.add('btn-off');
                btn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            }
        }

        function updateMyStatus(status) {
            db.collection('rooms').doc(ROOM_ID).collection('participants').doc(localId).update(status);
        }

        // --- 5. FIREBASE & WEBRTC ---
        async function joinRoom() {
            const roomRef = db.collection('rooms').doc(ROOM_ID);
            
            // Initialize my status
            await roomRef.collection('participants').doc(localId).set({
                video: true
            });

            window.onbeforeunload = () => roomRef.collection('participants').doc(localId).delete();

            // Listen for participants
            roomRef.collection('participants').onSnapshot(snap => {
                snap.docChanges().forEach(async change => {
                    const id = change.doc.id;
                    if (id === localId) return;

                    if (change.type === 'added') {
                        remoteUsers.push(id);
                        createPeerConnection(id, roomRef);
                        
                        // Create UI wrapper first
                        createRemoteVideoElement(id);
                        updateGridLayout();

                        // WebRTC Offer Logic
                        const pc = peerConnections[id];
                        const offer = await pc.createOffer();
                        await pc.setLocalDescription(offer);
                        roomRef.collection('participants').doc(id).collection('messages').add({
                            sender: localId, type: 'offer', sdp: offer
                        });
                    }
                    if (change.type === 'removed') {
                        remoteUsers = remoteUsers.filter(u => u !== id);
                        removeRemoteVideoElement(id);
                        if(peerConnections[id]) peerConnections[id].close();
                        delete peerConnections[id];
                        updateGridLayout();
                    }
                    if (change.type === 'modified') {
                        // Handle Remote Video ON/OFF status
                        const data = change.doc.data();
                        const wrapper = document.getElementById(`wrapper-${id}`);
                        if(wrapper) {
                            if (data.video === false) wrapper.classList.add('video-off');
                            else wrapper.classList.remove('video-off');
                        }
                    }
                });
            });

            // Listen for Signaling Messages
            roomRef.collection('participants').doc(localId).collection('messages').onSnapshot(snap => {
                snap.docChanges().forEach(async change => {
                    if (change.type === 'added') {
                        const data = change.doc.data();
                        const sender = data.sender;
                        change.doc.ref.delete();

                        if (!peerConnections[sender]) {
                            // If we received an offer but missed the 'added' participant event (race condition),
                            // ensure we have a PC and UI
                            remoteUsers.push(sender);
                            createRemoteVideoElement(sender);
                            createPeerConnection(sender, roomRef);
                            updateGridLayout();
                        }
                        
                        const pc = peerConnections[sender];
                        if (data.type === 'offer') {
                            await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
                            const answer = await pc.createAnswer();
                            await pc.setLocalDescription(answer);
                            roomRef.collection('participants').doc(sender).collection('messages').add({
                                sender: localId, type: 'answer', sdp: answer
                            });
                        } else if (data.type === 'answer') {
                            await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
                        } else if (data.type === 'candidate') {
                            try { await pc.addIceCandidate(new RTCIceCandidate(data.candidate)); } catch(e){}
                        }
                    }
                });
            });
        }

        function createPeerConnection(id, roomRef) {
            const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun1.l.google.com:19302' }] });
            peerConnections[id] = pc;
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            pc.onicecandidate = e => {
                if (e.candidate) {
                    roomRef.collection('participants').doc(id).collection('messages').add({
                        sender: localId, type: 'candidate', candidate: e.candidate.toJSON()
                    });
                }
            };
            
            pc.ontrack = e => {
                const vid = document.getElementById(`video-${id}`);
                if(vid) vid.srcObject = e.streams[0];
            };
        }

        // --- UI HELPERS ---
        function createRemoteVideoElement(id) {
            if (document.getElementById(`wrapper-${id}`)) return;
            
            const wrapper = document.createElement('div');
            wrapper.className = 'video-wrapper';
            wrapper.id = `wrapper-${id}`;
            
            // Random color for avatar
            const colors = ['#f87171', '#fbbf24', '#34d399', '#60a5fa', '#a78bfa'];
            const color = colors[Math.floor(Math.random() * colors.length)];

            wrapper.innerHTML = `
                <video id="video-${id}" autoplay playsinline></video>
                <div class="avatar-placeholder">
                    <div class="avatar-circle" style="color:${color}; border-color:${color}">
                        User
                    </div>
                </div>
            `;
            videoGrid.appendChild(wrapper);
        }

        function removeRemoteVideoElement(id) {
            const el = document.getElementById(`wrapper-${id}`);
            if (el) el.remove();
        }

        function leaveCall() {
            db.collection('rooms').doc(ROOM_ID).collection('participants').doc(localId).delete()
            .then(() => location.reload());
        }
    </script>
</body>
</html>
